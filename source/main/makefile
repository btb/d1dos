#
# Makefile for DESCENT execuable
#

INI_FILE = inferno.ini

# Load this person's personal settings
%include $(INI_FILE)

# Set target system if not in INI file, and make sure it's in uppercase
TARGSYS ?= DOS4G
TARGSYS := $(TARGSYS,UC)

# Where we're running the game.  Set here if no env var
MINERGAME ?= $(MINERLOCAL)\game

# Where to find libraries we didn't write
#EXTLIB_DIR = $(MINERLOCAL)\source\extlib
#EXTLIBS = $(EXTLIB_DIR)\greenlf $(EXTLIB_DIR)\sos
EXTLIBS = $(MINERLOCAL)\source\external $(MINERLOCAL)\support

# What programs to make
%ifdef SHAREWARE
PROGS = $(MINERGAME)\dcntshr
%else
PROGS = $(MINERGAME)\descentr
%endif

DESCENT_LIBS =	3d.lib gr.lib fix.lib \
				io.lib iff.lib vecmat.lib \
				cfile.lib \
				mem.lib \
				div0.lib misc.lib texmap.lib \
				sosdigi.lib \
				sosmidi.lib \
				loadpats.lib \
				commlib.lib

#		sosdigi.lib #sosmidi.lib \
		#iglasses.lib gclfr32.lib loadpats.lib
		#lzw.lib sosdwxcr.lib sosmwxcr.lib 

DESCENT_OBJS = inferno.obj game.obj gauges.obj mglobal.obj \
 	         scores.obj object.obj laser.obj physics.obj bm.obj \
             menu.obj gamesave.obj switch.obj effects.obj texmerge.obj polyobj.obj \
             gamemine.obj fireball.obj ai.obj aipath.obj hostage.obj \
             powerup.obj fuelcen.obj digi.obj render.obj hash.obj piggy.obj args.obj \
             gameseg.obj wall.obj collide.obj lighting.obj \
             robot.obj morph.obj vclip.obj weapon.obj fvi.obj newdemo.obj titles.obj \
             vfx.obj \
             vfxread.obj \
             gameseq.obj controls.obj automap.obj text.obj \
             network.obj victor.obj newmenu.obj netmisc.obj \
             gamefont.obj joydefs.obj hud.obj playsave.obj \
             endlevel.obj terrain.obj kconfig.obj modem.obj  \
             multi.obj cntrlcen.obj credits.obj config.obj soscodec.obj kmatrix.obj \
             paging.obj mission.obj iglasses.obj songs.obj bmread.obj multibot.obj \
             state.obj
             #nocomlib.obj slew.obj dumpmine.obj 
             #demo.obj garage.obj radar.obj coindev.obj serial.obj vfxread.obj victor.obj

# Link flags for Descent
DESCENT_LFLAGS = option map,verbose,stack=50k

# Force include of settings for all files
GLOBAL_INCFILES = settings.h

# DescentR is really Descent
#DESCENTR_SRCS   = $(DESCENT_SRCS)
DESCENTR_OBJS   = $(DESCENT_OBJS)
DESCENTR_LIBS   = $(DESCENT_LIBS)
DESCENTR_DIRS   = $(DESCENT_DIRS)
DESCENTR_LFLAGS = $(DESCENT_LFLAGS)
DESCENTR_DATA   = $(DESCENT_DATA)

# DcntShr is really Descent
#DCNTSHR_SRCS   = $(DESCENT_SRCS)
DCNTSHR_OBJS   = $(DESCENT_OBJS)
DCNTSHR_LIBS   = $(DESCENT_LIBS)
DCNTSHR_DIRS   = $(DESCENT_DIRS)
DCNTSHR_LFLAGS = $(DESCENT_LFLAGS)
DCNTSHR_DATA   = $(DESCENT_DATA)

#Rule for getting game data files
data .NODEFAULT:
	@($(MINERGAME,Z);cd $(MINERGAME);			\
	  dir /b /a-d $(MINER)\game >dir.out;			\
	  rcsfiles >files.rcs;					\
	  $(MAKE) $(MFLAGS) -f $(MINER)\game\makefile all;	\
	  del dir.out)

# Check various settings for conflicts
.BEFORE::
	%if %defined(BUILD_EDITOR) && %defined(NDEBUG)
	  %error 1 Error in $(INI_FILE,UC): If BUILD_EDITOR defined, NDEBUG must not be.
	%endif
	%if %defined(ARCADE) && !%defined(NEWDEMO)
	  %error 1 Error in $(INI_FILE,UC): ARCADE option requires that NEWDEMO also be set.
	%endif
	%if %defined(DEMO_ONLY) && !%defined(NEWDEMO)
	  %error 1 Error in $(INI_FILE,UC): DEMO_ONLY defined, but NEWDEMO not.
	%endif

# Set up personal settings
.BEFORE::
	@%echo // >settings.tmp
	@%echo // Auto-generated include file >>settings.tmp
	@%echo // Generated by MAKE from $(INI_FILE,UC) settings >>settings.tmp
	@%echo // >>settings.tmp
	@%echo >>settings.tmp
	@%echo \#define NEWDEMO				//Demo is always IN >>settings.tmp
	%do def_setting  _IVAR="BUILD_EDITOR" _SVAR="EDITOR"
	%do def_setting  _IVAR="RELEASE_VERSION" _SVAR="RELEASE"
	%do def_setting  _IVAR="ARCADE"
	%do def_setting  _IVAR="DEMO_ONLY"
	%do def_setting  _IVAR="NDEBUG"
	%do def_setting  _IVAR="NMONO"
	%do def_setting  _IVAR="MARK_ON" _SVAR="_MARK_ON"
	%do def_setting  _IVAR="PASSWORD" _SVAL=$(PASSWORD)
	%do def_setting  _IVAR="STORE_DEMO"
	%do def_setting2 _IVAR="PIGGY_NO_PAGING" _SVAR="PIGGY_USE_PAGING"
	%do def_setting  _IVAR="DEST_SAT"
	%do def_setting  _IVAR="REQUIRE_CD"
	%do def_setting  _IVAR="USE_CD"
	%do def_setting  _IVAR="ROCKWELL_CODE"
	%do def_setting  _IVAR="COMPACT_SEGS"
	%do def_setting2 _IVAR="NO_MULTIPLAYER" _SVAR="NETWORK"
	%if !%exists(settings.h)
	  @copy settings.tmp settings.h >nul
	%else
	  --1 @(cd . ; diff settings.tmp settings.h >____temp.tmp)
   #   %abort settings
	  %if ! -z ____temp.tmp
	    @+attrib -r settings.h	#make sure we can write to the file
	    @copy settings.tmp settings.h >nul
	  %endif
	%endif
	@del settings.tmp
	@del ____temp.tmp

# Subroutine to add lines to SETTINGS.H
def_setting .PHONY .NODEFAULT:
	#%if !%defined(_SVAR)
	%if "$(_SVAR)" == ""
	  @%set _SVAR = $(_IVAR)
	%endif
	%if "$(_SVAL)" == ""
	  @%set _SVAL = 1
	%endif
	@%if "$(_IVAL)" != ""
	  @%if "$($(_IVAR))" == $(_IVAL)
	    @%echo \#define $(_SVAR) $(_SVAL)				//$(_IVAR) == $(_IVAL)  >>settings.tmp
	  %else
	    @%echo //\#define $(_SVAR)				//$(_IVAR) != $(_IVAL) >>settings.tmp
	  %endif
	%else
	  @%if %defined($(_IVAR))
	    @%echo \#define $(_SVAR) $(_SVAL)				//$(_IVAR) set  >>settings.tmp
	  %else
	    @%echo //\#define $(_SVAR)				//$(_IVAR) not set >>settings.tmp
	  %endif
	%endif
	@%set _SVAR =
	@%set _SVAL =
	@%set _IVAL =
	
# Version of def_settings to add line if variable NOT set (or not equal)
def_setting2 .PHONY .NODEFAULT:
	#%if !%defined(_SVAR)
	%if "$(_SVAR)" == ""
	  @%set _SVAR = $(_IVAR)
	%endif
	%if "$(_SVAL)" == ""
	  @%set _SVAL = 1
	%endif
	@%if "$(_IVAL)" != ""
	  @%if "$($(_IVAR))" != $(_IVAL)
	    @%echo \#define $(_SVAR) $(_SVAL)				//$(_IVAR) != $(_IVAL)  >>settings.tmp
	  %else
	    @%echo //\#define $(_SVAR)				//$(_IVAR) == $(_IVAL) >>settings.tmp
	  %endif
	%else
	  @%if %defined($(_IVAR))
	    @%echo //\#define $(_SVAR)				//$(_IVAR) set >>settings.tmp
	  %else
	    @%echo \#define $(_SVAR) $(_SVAL)				//$(_IVAR) not set  >>settings.tmp
	  %endif
	%endif
	@%set _SVAR =
	@%set _SVAL =
	

#set up serial number and name header file
.BEFORE::
	@%echo // >vers_id.tmp
	@%echo // Auto-generated include file >>vers_id.tmp
	@%echo // Generated by MAKE from $(INI_FILE,UC) settings >>vers_id.tmp
	@%echo // >>vers_id.tmp
	@%echo >>vers_id.tmp
	@%if !%defined(VERSION_NAME) && !%defined(RELEASE_VERSION)
	  @%set VERSION_NAME = "Internal Development ($(USER))"
	@%endif
	@%echo >>vers_id.tmp
	@%if %defined(VERSION_NAME)
	  @%echo \#define VERSION_NAME	$(VERSION_NAME) >>vers_id.tmp
	@%endif
	@%if %defined(SHAREWARE)
	  @%echo \#define VERSION_TYPE	"SHAREWARE" >>vers_id.tmp
	@%else
	  @%if %defined(DEST_SAT)
	    @%echo \#define VERSION_TYPE	"OEM" >>vers_id.tmp
	  @%else
	    @%echo \#define VERSION_TYPE	"REGISTERED" >>vers_id.tmp
	  @%endif
	@%endif
	@%echo >>vers_id.tmp
	%if !%exists(vers_id.h)
	  @copy vers_id.tmp vers_id.h >nul
	%else
	  --1 @diff vers_id.tmp vers_id.h >____temp.tmp
	  %if ! -z ____temp.tmp
	    @attrib -r vers_id.h	#make sure we can write to the file
	    @copy vers_id.tmp vers_id.h >nul
	  %endif
	%endif
	# If release version, always touch file to force rebuild of
	# inferno.c to update date/time
	%if %defined(RELEASE_VERSION)
	  @touch vers_id.h
	%endif

	@del vers_id.tmp
	@del ____temp.tmp

# default .PHONY: descentr.exe

# descent.exe: $(DESCENT_OBJS) $(DESCENT_LIBS)
# 	*wlink option map,stack=50k,stub=$(%watcom)\binb\wstub.exe name $@ sys dos4g file { $(DESCENT_OBJS) } library { $(DESCENT_LIBS) }

# descentr.exe: descent.exe
# 	copy descent.exe $@

# LCLEAN = 1
# lclean .PHONY:
# 	del descent.exe
# 	del descentr.exe

#rules and targets common to all Miner makefiles
%include $(INIT)\makefile.def
